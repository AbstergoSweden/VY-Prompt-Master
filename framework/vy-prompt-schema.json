{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://vercept.ai/schemas/vy-prompt-v3.json",
  "title": "VY Prompt Specification Schema",
  "description": "JSON Schema for validating VY (Vercept) automation prompt specifications generated by the Unified Framework v3.0",
  "type": "object",
  "required": [
    "identity",
    "purpose",
    "context",
    "inputs",
    "task",
    "constraints",
    "output_format",
    "self_check"
  ],
  "additionalProperties": false,
  "properties": {
    "identity": {
      "type": "string",
      "description": "Role or persona for VY to adopt during task execution",
      "minLength": 1,
      "examples": ["VY Prompt Engineering Persona", "Safari Cookie Cleaner", "File Organization Agent"]
    },
    "purpose": {
      "type": "string",
      "description": "Clear statement of what this prompt accomplishes",
      "minLength": 10
    },
    "context": {
      "type": "object",
      "description": "Execution environment and platform context",
      "required": ["platform", "access_method", "auth_state", "environment"],
      "additionalProperties": false,
      "properties": {
        "platform": {
          "type": "string",
          "description": "Target application, site, or OS",
          "examples": ["VY (Vercept) automation agent on macOS", "Safari browser", "Finder"]
        },
        "access_method": {
          "type": "string",
          "enum": ["desktop", "web", "mobile", "hybrid"],
          "description": "How VY will interact with the target"
        },
        "auth_state": {
          "type": "string",
          "enum": ["logged_in", "requires_login", "public", "user_logged_in_as_needed"],
          "description": "Authentication state required for task"
        },
        "environment": {
          "oneOf": [
            {
              "type": "string",
              "description": "Simple environment description"
            },
            {
              "type": "object",
              "description": "Detailed environment specification",
              "properties": {
                "os": {
                  "type": "string",
                  "examples": ["macOS", "macOS Ventura", "macOS Sonoma"]
                },
                "browser": {
                  "type": "string",
                  "examples": ["Safari", "Chrome", "Arc", "Firefox", "User's default browser"]
                },
                "shell": {
                  "type": "string",
                  "examples": ["zsh", "bash", "Default user shell"]
                },
                "version": {
                  "type": "string",
                  "description": "Specific version requirements if any"
                }
              },
              "additionalProperties": true
            }
          ]
        }
      }
    },
    "inputs": {
      "type": "array",
      "description": "List of inputs required for task execution",
      "minItems": 1,
      "items": {
        "$ref": "#/$defs/input"
      }
    },
    "task": {
      "type": "object",
      "description": "The automation task specification",
      "required": ["goal", "steps"],
      "additionalProperties": false,
      "properties": {
        "goal": {
          "type": "string",
          "description": "Desired end state after task completion",
          "minLength": 10
        },
        "steps": {
          "type": "array",
          "description": "Ordered list of UI action steps",
          "minItems": 1,
          "items": {
            "$ref": "#/$defs/step"
          }
        }
      }
    },
    "constraints": {
      "type": "array",
      "description": "Hard constraints that must be followed during execution",
      "minItems": 1,
      "items": {
        "type": "string",
        "minLength": 5
      }
    },
    "assumptions": {
      "type": "array",
      "description": "Documented assumptions with risk mitigations",
      "items": {
        "$ref": "#/$defs/assumption"
      }
    },
    "output_format": {
      "type": "object",
      "description": "Expected output format and evidence requirements",
      "required": ["type"],
      "properties": {
        "type": {
          "type": "string",
          "enum": ["yaml", "markdown", "plaintext", "structured_data", "json"],
          "description": "Output format type"
        },
        "structure": {
          "type": "string",
          "description": "Description of expected output structure"
        },
        "evidence_requirements": {
          "oneOf": [
            {
              "type": "string"
            },
            {
              "type": "array",
              "items": {
                "type": "string"
              }
            }
          ],
          "description": "What evidence must be captured"
        }
      },
      "additionalProperties": true
    },
    "robustness_improvements": {
      "type": "object",
      "description": "Retry, rollback, and monitoring configurations",
      "properties": {
        "retries": {
          "type": "array",
          "items": {
            "$ref": "#/$defs/retry_config"
          }
        },
        "rollbacks": {
          "type": "array",
          "items": {
            "$ref": "#/$defs/rollback_config"
          }
        },
        "monitoring": {
          "type": "array",
          "items": {
            "$ref": "#/$defs/monitoring_checkpoint"
          }
        }
      },
      "additionalProperties": false
    },
    "validation_tests": {
      "type": "object",
      "description": "Tests to validate the prompt specification",
      "properties": {
        "schema_tests": {
          "type": "array",
          "items": {
            "type": "string"
          }
        },
        "ui_tests": {
          "type": "array",
          "items": {
            "type": "string"
          }
        },
        "safety_tests": {
          "type": "array",
          "items": {
            "type": "string"
          }
        },
        "determinism_tests": {
          "type": "array",
          "items": {
            "type": "string"
          }
        }
      },
      "additionalProperties": false
    },
    "failure_playbooks": {
      "type": "array",
      "description": "Predefined responses for common failure scenarios",
      "items": {
        "$ref": "#/$defs/failure_playbook"
      }
    },
    "self_check": {
      "type": "array",
      "description": "Validation questions to verify prompt quality",
      "minItems": 1,
      "items": {
        "type": "string",
        "minLength": 10
      }
    },
    "examples": {
      "type": "array",
      "description": "Optional example inputs and expected outputs",
      "items": {
        "type": "object",
        "properties": {
          "input": {
            "type": "string"
          },
          "output": {
            "type": "string"
          },
          "description": {
            "type": "string"
          }
        }
      }
    },
    "inputs_missing": {
      "type": "array",
      "description": "List of required inputs that were not provided (blocks execution)",
      "items": {
        "type": "object",
        "required": ["name", "description"],
        "properties": {
          "name": {
            "type": "string"
          },
          "description": {
            "type": "string"
          },
          "required": {
            "type": "boolean",
            "default": true
          }
        }
      }
    }
  },
  "$defs": {
    "input": {
      "type": "object",
      "description": "Input parameter specification",
      "required": ["name", "required", "description"],
      "additionalProperties": false,
      "properties": {
        "name": {
          "type": "string",
          "description": "Input parameter name",
          "pattern": "^[a-z][a-z0-9_]*$"
        },
        "required": {
          "type": "boolean",
          "description": "Whether this input is required"
        },
        "description": {
          "type": "string",
          "description": "What this input provides"
        },
        "example": {
          "type": "string",
          "description": "Example value for this input"
        },
        "default": {
          "description": "Default value if not provided"
        },
        "type": {
          "type": "string",
          "enum": ["string", "number", "boolean", "array", "object", "url", "path", "date"],
          "description": "Data type of the input"
        },
        "validation": {
          "type": "object",
          "description": "Validation rules for the input",
          "properties": {
            "pattern": {
              "type": "string",
              "description": "Regex pattern for validation"
            },
            "min_length": {
              "type": "integer"
            },
            "max_length": {
              "type": "integer"
            },
            "enum": {
              "type": "array",
              "description": "Allowed values"
            }
          }
        }
      }
    },
    "step": {
      "type": "object",
      "description": "Single UI action step following locate→confirm→act→verify pattern",
      "required": [
        "step_id",
        "intent",
        "locate",
        "confirm_target",
        "act",
        "verify_outcome",
        "fallback_paths",
        "safety_gate"
      ],
      "additionalProperties": false,
      "properties": {
        "step_id": {
          "type": "string",
          "description": "Unique step identifier",
          "pattern": "^step_[0-9]{3}_[a-z][a-z0-9_]*$",
          "examples": ["step_001_launch_safari", "step_002_navigate_url", "step_010_confirm_deletion"]
        },
        "intent": {
          "type": "string",
          "description": "Single-sentence purpose of this step",
          "minLength": 10
        },
        "locate": {
          "type": "string",
          "description": "Unambiguous UI element description with unique identifiers",
          "minLength": 10
        },
        "confirm_target": {
          "type": "string",
          "description": "Observable criteria to verify correct element BEFORE acting"
        },
        "act": {
          "type": "string",
          "description": "Specific action with exact parameters (click/type/select/scroll/keyboard_shortcut)",
          "minLength": 5
        },
        "verify_outcome": {
          "type": "string",
          "description": "Observable evidence of success AFTER acting",
          "minLength": 10
        },
        "fallback_paths": {
          "type": "array",
          "description": "Alternative approaches if primary action fails (ordered by reliability)",
          "items": {
            "type": "string",
            "minLength": 10
          }
        },
        "safety_gate": {
          "type": "string",
          "description": "Safety classification for this step",
          "enum": ["safe", "caution", "checkpoint", "irreversible_requires_confirmation"]
        },
        "wait_before": {
          "type": "integer",
          "description": "Milliseconds to wait before executing this step",
          "minimum": 0,
          "maximum": 10000
        },
        "wait_after": {
          "type": "integer",
          "description": "Milliseconds to wait after executing this step",
          "minimum": 0,
          "maximum": 10000
        },
        "screenshot_before": {
          "type": "boolean",
          "description": "Whether to capture screenshot before this step",
          "default": false
        },
        "screenshot_after": {
          "type": "boolean",
          "description": "Whether to capture screenshot after this step",
          "default": false
        },
        "user_confirmation_required": {
          "type": "boolean",
          "description": "Whether explicit user confirmation is required before this step",
          "default": false
        },
        "confirmation_prompt": {
          "type": "string",
          "description": "Message to display when requesting user confirmation"
        },
        "max_retries": {
          "type": "integer",
          "description": "Maximum retry attempts for this specific step",
          "minimum": 0,
          "maximum": 5,
          "default": 2
        },
        "timeout": {
          "type": "integer",
          "description": "Timeout in milliseconds for this step",
          "minimum": 100,
          "maximum": 300000
        },
        "notes": {
          "type": "string",
          "description": "Additional notes or context for this step"
        }
      }
    },
    "assumption": {
      "type": "object",
      "description": "Documented assumption with risk mitigation",
      "required": ["id", "statement", "confidence", "risk", "mitigation", "verification_method"],
      "additionalProperties": false,
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique assumption identifier",
          "pattern": "^[a-z][a-z0-9_]*$",
          "examples": ["vy_local_agent_presence", "browser_default_availability"]
        },
        "statement": {
          "type": "string",
          "description": "What we're assuming",
          "minLength": 10
        },
        "confidence": {
          "type": "string",
          "description": "Confidence level in this assumption",
          "enum": ["low", "medium", "high"]
        },
        "risk": {
          "type": "string",
          "description": "What breaks if this assumption is wrong",
          "minLength": 10
        },
        "mitigation": {
          "type": "string",
          "description": "How to reduce or handle the risk",
          "minLength": 10
        },
        "verification_method": {
          "type": "string",
          "description": "How to check if the assumption holds",
          "minLength": 10
        }
      }
    },
    "retry_config": {
      "type": "object",
      "description": "Retry configuration for error recovery",
      "required": ["condition", "max_attempts", "backoff"],
      "properties": {
        "condition": {
          "type": "string",
          "description": "When to trigger retry"
        },
        "max_attempts": {
          "type": "integer",
          "description": "Maximum number of retry attempts",
          "minimum": 1,
          "maximum": 5,
          "default": 2
        },
        "backoff": {
          "type": "string",
          "description": "Backoff strategy (e.g., '250ms → 500ms → 1000ms')"
        },
        "recovery_action": {
          "type": "string",
          "description": "Action to take during recovery"
        }
      }
    },
    "rollback_config": {
      "type": "object",
      "description": "Rollback configuration for failure recovery",
      "required": ["trigger", "procedure"],
      "properties": {
        "trigger": {
          "type": "string",
          "description": "When to trigger rollback"
        },
        "procedure": {
          "oneOf": [
            {
              "type": "string"
            },
            {
              "type": "array",
              "items": {
                "type": "string"
              }
            }
          ],
          "description": "Steps to execute during rollback"
        },
        "reversibility_level": {
          "type": "string",
          "description": "Level of state reversion",
          "enum": [
            "full_system_reversion",
            "application_state_reversion",
            "partial_cleanup",
            "graceful_abort"
          ]
        }
      }
    },
    "monitoring_checkpoint": {
      "type": "object",
      "description": "Checkpoint for progress monitoring",
      "required": ["checkpoint", "evidence"],
      "properties": {
        "checkpoint": {
          "type": "string",
          "description": "Step ID or condition for checkpoint"
        },
        "evidence": {
          "type": "string",
          "description": "What evidence to capture at this checkpoint"
        },
        "summary_point": {
          "type": "string",
          "description": "Human-readable summary of progress at this point"
        }
      }
    },
    "failure_playbook": {
      "type": "object",
      "description": "Predefined response for a failure scenario",
      "required": ["name", "detection", "response"],
      "additionalProperties": false,
      "properties": {
        "name": {
          "type": "string",
          "description": "Identifier for this failure type",
          "pattern": "^[a-z][a-z0-9_]*$",
          "examples": ["ui_not_found", "unexpected_modal", "auth_blocked"]
        },
        "detection": {
          "type": "string",
          "description": "How to detect this failure condition"
        },
        "response": {
          "type": "array",
          "description": "Ordered steps to take when this failure occurs",
          "minItems": 1,
          "items": {
            "type": "string"
          }
        },
        "escalation": {
          "type": "string",
          "description": "What to do if response steps don't resolve the issue"
        }
      }
    },
    "safety_gate": {
      "type": "string",
      "description": "Safety classification enum",
      "enum": ["safe", "caution", "checkpoint", "irreversible_requires_confirmation"]
    },
    "action_type": {
      "type": "string",
      "description": "Types of UI actions VY can perform",
      "enum": [
        "click",
        "right_click",
        "double_click",
        "triple_click",
        "type",
        "scroll",
        "scroll_up",
        "scroll_down",
        "select",
        "drag",
        "keyboard_shortcut",
        "key_press",
        "key_hold",
        "hover",
        "wait",
        "screenshot",
        "ocr_extract"
      ]
    }
  }
}
